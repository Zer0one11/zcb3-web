<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zcb3 WEB</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --accent: #00ff7f; --bg: #0b0b0e; --card: #121217; --border: #22222b; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 15px; }
        
        .container { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 30px; width: 100%; max-width: 480px; box-shadow: 0 30px 60px rgba(0,0,0,0.8); }
        h1 { color: var(--accent); font-size: 24px; text-align: center; text-transform: uppercase; margin-bottom: 25px; letter-spacing: 4px; font-weight: 900; }

        label { display: block; font-size: 10px; color: #555; margin-bottom: 8px; text-transform: uppercase; font-weight: 800; letter-spacing: 1.5px; }
        
        /* Кнопки основных паков из репозитория clicks */
        .main-packs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .pack-btn { background: #1a1a20; border: 1px solid var(--border); color: #888; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 700; transition: 0.3s; font-size: 13px; }
        .pack-btn:hover { border-color: var(--accent); color: #fff; }
        .pack-btn.active { background: rgba(0,255,127,0.1); border-color: var(--accent); color: var(--accent); }

        select { width: 100%; background: #000; color: #aaa; border: 1px solid var(--border); padding: 12px; border-radius: 10px; margin-bottom: 20px; outline: none; }

        .drop-zone { border: 2px dashed #222; padding: 35px; text-align: center; border-radius: 16px; cursor: pointer; color: #666; margin-bottom: 25px; transition: 0.3s; }
        .drop-zone.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,127,0.05); }

        .controls-group { background: #08080a; padding: 15px; border-radius: 12px; border: 1px solid #1a1a1f; margin-bottom: 20px; }
        .control-row { margin-bottom: 15px; }
        .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; }

        .status-box { padding: 12px; background: #08080a; border-radius: 10px; font-family: monospace; font-size: 10px; height: 40px; color: var(--accent); border: 1px solid #1a1a1f; margin-bottom: 20px; }
        
        .btn-go { width: 100%; background: var(--accent); color: #000; padding: 20px; border-radius: 14px; font-weight: 900; border: none; cursor: pointer; text-transform: uppercase; display: none; font-size: 16px; }

        .preview { margin-top: 25px; display: none; border-top: 1px solid #222; padding-top: 20px; }
        audio { width: 100%; filter: invert(1) hue-rotate(180deg); margin-bottom: 15px; }
        .dl-link { display: block; text-align: center; color: var(--accent); text-decoration: none; font-size: 12px; font-weight: bold; border: 1px solid rgba(0,255,127,0.3); padding: 12px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1>zcb3 WEB</h1>
    
    <label>Основные паки (из репозитория clicks):</label>
    <div class="main-packs">
        <button class="pack-btn" onclick="loadMainPack('g502', this)">G502 Hero</button>
        <button class="pack-btn" onclick="loadMainPack('viper', this)">Viper 8K</button>
    </div>

    <label>Все паки:</label>
    <select id="packSelect" onchange="loadZip(this.value)">
        <option>Загрузка...</option>
    </select>

    <label>Макрос:</label>
    <div class="drop-zone" onclick="document.getElementById('macroInput').click()" id="dropZone">Выберите .json или .re3</div>
    <input type="file" id="macroInput" style="display: none;" onchange="handleMacro(this.files[0])">

    <div class="controls-group">
        <div class="control-row">
            <div class="row-header">
                <label>Громкость:</label>
                <span id="volValue" style="color:var(--accent); font-size:11px">100%</span>
            </div>
            <input type="range" id="volRange" min="0" max="200" value="100" oninput="volValue.innerText = this.value + '%'">
        </div>
        <div class="control-row" style="margin-bottom:0">
            <div class="row-header">
                <label>Оффсет (задержка):</label>
                <span id="offValue" style="color:var(--accent); font-size:11px">-140 ms</span>
            </div>
            <input type="range" id="offRange" min="-500" max="500" value="-140" oninput="offValue.innerText = this.value + ' ms'">
        </div>
    </div>

    <div class="status-box" id="log">Готов</div>
    <button id="renderBtn" class="btn-go" onclick="renderAudio()">Собрать аудио</button>

    <div class="preview" id="previewArea">
        <audio id="player" controls></audio>
        <a id="download" class="dl-link" href="#">СКАЧАТЬ WAV</a>
    </div>
</div>

<script>
    const REPO = "Zer0one11/zcb3-web"; 
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let audioCache = { clicks: [], releases: [] }, macroEvents = [], currentTps = 240;

    function addLog(m) { log.innerText = "> " + m; }

    // Загрузка "основных" паков из папки clicks репозитория
    async function loadMainPack(model, btn) {
        document.querySelectorAll('.pack-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('packSelect').value = "";
        
        addLog(`Загрузка пака ${model}...`);
        audioCache = { clicks: [], releases: [] };
        
        try {
            // Предполагаем структуру: clicks/g502/click1.wav, clicks/g502/rel1.wav и т.д.
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/clicks/${model}`);
            const files = await res.json();
            
            const p = files.map(async file => {
                if (file.name.endsWith('.wav') || file.name.endsWith('.ogg')) {
                    const audioRes = await fetch(file.download_url);
                    const b = await ctx.decodeAudioData(await audioRes.arrayBuffer());
                    if (file.name.toLowerCase().includes('click')) audioCache.clicks.push(b);
                    else if (file.name.toLowerCase().includes('rel')) audioCache.releases.push(b);
                }
            });
            
            await Promise.all(p);
            addLog(`Пак ${model} готов!`);
            checkReady();
        } catch (e) { addLog("Ошибка загрузки основного пака"); }
    }

    async function initPacks() {
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/packs`);
            const files = await res.json();
            const sel = document.getElementById('packSelect');
            sel.innerHTML = '<option value="" disabled selected>Или выберите ZIP пак...</option>';
            files.filter(f => f.name.endsWith('.zip')).forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.name.replace('.zip', '');
                opt.innerText = opt.value.replace(/-/g, ' ').toUpperCase();
                sel.appendChild(opt);
            });
        } catch (e) { addLog("Ошибка списка"); }
    }

    async function loadZip(id) {
        addLog(`Загрузка ZIP: ${id}...`);
        audioCache = { clicks: [], releases: [] };
        try {
            const res = await fetch(`https://raw.githubusercontent.com/${REPO}/main/packs/${id}.zip`);
            const zip = await JSZip.loadAsync(await res.blob());
            const p = [];
            zip.forEach((path, file) => {
                if (!file.dir && (path.endsWith('.wav') || path.endsWith('.ogg'))) {
                    p.push(file.async("arraybuffer").then(async d => {
                        const b = await ctx.decodeAudioData(d);
                        if (path.toLowerCase().includes('click')) audioCache.clicks.push(b);
                        else audioCache.releases.push(b);
                    }));
                }
            });
            await Promise.all(p);
            addLog("ZIP пак загружен");
            checkReady();
        } catch (e) { addLog("Ошибка ZIP"); }
    }

    async function handleMacro(f) {
        if(!f) return;
        const buf = await f.arrayBuffer();
        try {
            if(f.name.endsWith('.re3')) {
                const v = new DataView(buf); currentTps = v.getFloat32(0, true);
                let o = 20 + (v.getUint32(4, true) + v.getUint32(8, true)) * 32;
                macroEvents = [];
                for(let i=0; i<v.getUint32(12, true); i++) {
                    macroEvents.push({ f: v.getUint32(o, true), d: v.getUint8(o+4)!==0 }); o += 16;
                }
            } else {
                const d = JSON.parse(new TextDecoder().decode(buf));
                currentTps = d.framerate || 240;
                macroEvents = (d.inputs || d.events).map(e => ({ f: e.frame ?? e.f, d: e.down ?? e.d }));
            }
            dropZone.innerText = "✅ " + f.name; dropZone.classList.add('active');
            checkReady();
        } catch(e) { addLog("Ошибка макроса"); }
    }

    function checkReady() { if(audioCache.clicks.length && macroEvents.length) renderBtn.style.display = 'block'; }

    async function renderAudio() {
        addLog("Рендеринг...");
        const vol = volRange.value / 100;
        const offset = parseInt(offRange.value) / 1000;
        const dur = (macroEvents[macroEvents.length-1].f / currentTps) + 2;
        const oCtx = new OfflineAudioContext(1, 44100 * Math.max(1, dur), 44100);
        
        macroEvents.forEach(ev => {
            const time = (ev.f / currentTps) + offset;
            if (time < 0) return;
            const pool = ev.d ? audioCache.clicks : audioCache.releases;
            if (pool.length) {
                const s = oCtx.createBufferSource(); s.buffer = pool[Math.floor(Math.random()*pool.length)];
                const g = oCtx.createGain(); g.gain.value = (0.8 + Math.random()*0.2) * vol;
                s.connect(g); g.connect(oCtx.destination); s.start(time);
            }
        });
        
        const res = await oCtx.startRendering();
        const url = URL.createObjectURL(bufferToWav(res));
        player.src = url; download.href = url; download.download = "result.wav";
        previewArea.style.display = 'block'; addLog("Готово!");
    }

    function bufferToWav(ab) {
        const n=1, len=ab.length*2+44, b=new ArrayBuffer(len), v=new DataView(b);
        const s=(o,t)=>{for(let i=0;i<t.length;i++)v.setUint8(o+i,t.charCodeAt(i))};
        s(0,'RIFF'); v.setUint32(4,len-8,true); s(8,'WAVE'); s(12,'fmt ');
        v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,n,true);
        v.setUint32(24,44100,true); v.setUint32(28,88200,true); v.setUint16(32,2,true);
        v.setUint16(34,16,true); s(36,'data'); v.setUint32(40,len-44,true);
        const d=ab.getChannelData(0);
        for(let i=0;i<d.length;i++){let x=Math.max(-1,Math.min(1,d[i]));v.setInt16(44+i*2,x<0?x*32768:x*32767,true)}
        return new Blob([b], {type:'audio/wav'});
    }

    window.onload = initPacks;
</script>
</body>
</html>
