<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>zcb3 WEB v12.0 - Mobile Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --accent: #00ff7f; --bg: #0b0b0e; --card: #121217; --border: #22222b; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 25px; width: 100%; max-width: 450px; box-sizing: border-box; position: relative; }
        
        .icon-btn { position: absolute; top: 20px; width: 35px; height: 35px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .converter-trigger { left: 20px; }
        .settings-trigger { right: 20px; }
        .icon-btn svg { fill: #000; width: 20px; height: 20px; }

        h1 { color: var(--accent); text-align: center; font-size: 22px; letter-spacing: 3px; margin: 10px 0 25px 0; }
        
        .pack-btn { background: #1a1a20; border: 1px solid var(--border); color: #888; padding: 15px; border-radius: 12px; width: 48%; font-weight: bold; margin-bottom: 15px; }
        .pack-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,127,0.1); }
        
        select, input[type="file"] { width: 100%; background: #1a1a20; color: #fff; border: 1px solid var(--border); padding: 12px; border-radius: 10px; margin-bottom: 15px; }
        
        .drop-zone { border: 2px dashed #333; padding: 30px 10px; text-align: center; border-radius: 15px; color: #666; font-size: 14px; margin-bottom: 20px; }
        .drop-zone.active { border-color: var(--accent); color: var(--accent); }
        
        .status-box { background: #000; padding: 15px; border-radius: 12px; font-family: monospace; font-size: 11px; color: var(--accent); min-height: 60px; border: 1px solid #1a1a1f; margin-bottom: 20px; overflow-wrap: break-word; }
        
        .btn-go { width: 100%; background: var(--accent); color: #000; padding: 18px; border-radius: 15px; font-weight: 900; border: none; display: none; text-transform: uppercase; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 20px; width: 85%; }
        
        .preview { margin-top: 20px; text-align: center; display: none; }
        audio { width: 100%; filter: invert(1); }
    </style>
</head>
<body>

<div class="container">
    <div class="icon-btn converter-trigger" onclick="toggleModal('converterModal', true)"><svg viewBox="0 0 24 24"><path d="M12,18L8,14H11V7H13V14H16L12,18M20,2H4A2,2 0 0,0 2,4V20A2,2 0 0,0 4,22H20A2,2 0 0,0 22,20V4C22,2.89 21.1,2 20,2Z"/></svg></div>
    <div class="icon-btn settings-trigger" onclick="toggleModal('settingsModal', true)"><svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.97 19.05,5.05L16.56,6.05C16.04,5.65 15.48,5.32 14.87,5.07L14.49,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.51,2.42L9.13,5.07C8.52,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.97 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.95C7.96,18.34 8.52,18.68 9.13,18.93L9.51,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.49,21.58L14.87,18.93C15.48,18.67 16.04,18.34 16.56,17.95L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg></div>
    
    <h1>zcb3 MOBILE</h1>

    <div style="display:flex; justify-content:space-between;">
        <button class="pack-btn" onclick="loadMainPack('g502', this)">G502</button>
        <button class="pack-btn" onclick="loadMainPack('Viper-8K', this)">VIPER</button>
    </div>

    <select id="packSelect" onchange="loadZipPack(this.value)"><option>Загрузка из облака...</option></select>

    <div class="drop-zone" onclick="document.getElementById('macroInput').click()" id="dropZone">НАЖМИ И ВЫБЕРИ МАКРОС</div>
    <input type="file" id="macroInput" style="display: none;" onchange="handleMacro(this.files[0])">

    <div class="status-box" id="log">Ожидание действий...</div>
    <button id="renderBtn" class="btn-go" onclick="renderAudio()">СДЕЛАТЬ ЗВУК</button>

    <div class="preview" id="previewArea">
        <audio id="player" controls></audio>
        <a id="downloadLink" style="display:block; color:var(--accent); margin-top:10px; font-weight:bold;">СКАЧАТЬ WAV</a>
    </div>
</div>

<div class="modal" id="converterModal">
    <div class="modal-content">
        <h3>КОНВЕРТЕР</h3>
        <select id="convMode"><option value="j2r">JSON -> RE3</option><option value="r2j">RE3 -> JSON</option></select>
        <input type="file" id="convFile">
        <button onclick="startConversion()" style="width:100%; padding:15px; background:var(--accent); border:none; border-radius:10px;">ПУСК</button>
        <button onclick="toggleModal('converterModal', false)" style="width:100%; background:none; color:#fff; border:none; margin-top:10px;">ЗАКРЫТЬ</button>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <h3>НАСТРОЙКИ</h3>
        <label>Громкость: <input type="range" id="volRange" min="0" max="200" value="100"></label>
        <label>Офсет: <input type="range" id="offRange" min="-500" max="500" value="-140"></label>
        <p>Свой ZIP:</p>
        <input type="file" id="zipInput" accept=".zip" onchange="loadCustomZip(this.files[0])">
        <button onclick="toggleModal('settingsModal', false)" style="width:100%; background:var(--accent); border:none; padding:10px; border-radius:10px; margin-top:10px;">ГОТОВО</button>
    </div>
</div>

<script>
    const REPO = "Zer0one11/zcb3-web";
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let audioCache = { clicks: [], releases: [] }, macroEvents = [], currentTps = 240;

    function addLog(m) { log.innerText = "> " + m; }
    function toggleModal(id, s) { document.getElementById(id).style.display = s ? 'flex' : 'none'; }

    // УЛЬТРА-ЗАГРУЗЧИК ZIP (ДЛЯ МОБИЛКИ)
    async function loadCustomZip(file) {
        if(!file) return;
        addLog("Анализ ZIP...");
        audioCache = { clicks: [], releases: [] };
        try {
            const zip = await JSZip.loadAsync(file);
            const files = Object.keys(zip.files);
            addLog(`Файлов в архиве: ${files.length}`);

            const loaders = [];
            zip.forEach((path, entry) => {
                if(!entry.dir && path.toLowerCase().endsWith('.wav')) {
                    loaders.push(entry.async("arraybuffer").then(async (ab) => {
                        const buffer = await ctx.decodeAudioData(ab);
                        const cleanPath = path.toLowerCase();
                        if (cleanPath.includes('click')) audioCache.clicks.push(buffer.getChannelData(0));
                        else if (cleanPath.includes('rel')) audioCache.releases.push(buffer.getChannelData(0));
                    }));
                }
            });

            await Promise.all(loaders);
            addLog(`УСПЕХ: ${audioCache.clicks.length} кликов, ${audioCache.releases.length} релизов`);
            if (audioCache.clicks.length === 0) addLog("⚠️ ВНИМАНИЕ: В ZIP нет папок 'Click'!");
            checkReady();
        } catch(e) { addLog("Ошибка ZIP: " + e.message); }
    }

    async function handleMacro(file) {
        if(!file) return;
        const buf = await file.arrayBuffer();
        const v = new DataView(buf);
        macroEvents = [];
        if(file.name.toLowerCase().endsWith('.re3')) {
            currentTps = v.getFloat32(0, true);
            const p1c = v.getUint32(4, true), p2c = v.getUint32(8, true), total = v.getUint32(12, true);
            let off = 20 + (p1c + p2c) * 32;
            for(let i=0; i<total; i++) {
                if(off+16 > buf.byteLength) break;
                macroEvents.push({ f: v.getUint32(off, true), d: v.getUint8(off+4)>0, p2: v.getUint8(off+5)!==0 });
                off += 16;
            }
        } else {
            const d = JSON.parse(new TextDecoder().decode(buf));
            currentTps = d.framerate || 240;
            const evs = d.inputs || d.events || [];
            macroEvents = evs.map(e => ({ f: e.frame ?? e.f, d: e.down ?? e.d, p2: e.p2 || e.player === 2 }));
        }
        addLog(`Макрос: ${file.name}\nTPS: ${currentTps}`);
        dropZone.innerText = file.name;
        checkReady();
    }

    async function renderAudio() {
        addLog("Рендеринг...");
        const vol = volRange.value/100, off = Math.floor((offRange.value/1000)*44100);
        const last = macroEvents[macroEvents.length-1];
        const len = Math.floor((last.f / currentTps) * 44100) + 88200;
        const L = new Float32Array(len), R = new Float32Array(len);

        macroEvents.forEach(ev => {
            const start = Math.floor((ev.f/currentTps)*44100) + off;
            if(start < 0) return;
            const pool = ev.d ? audioCache.clicks : audioCache.releases;
            if(pool.length) {
                const s = pool[Math.floor(Math.random()*pool.length)];
                const pL = ev.p2 ? 0.3 : 1.0, pR = ev.p2 ? 1.0 : 0.3;
                for(let j=0; j<s.length && (start+j)<len; j++) { L[start+j]+=s[j]*vol*pL; R[start+j]+=s[j]*vol*pR; }
            }
        });
        const blob = stereoWav(L, R);
        player.src = URL.createObjectURL(blob);
        downloadLink.href = player.src;
        downloadLink.download = "result.wav";
        previewArea.style.display = 'block';
        addLog("Готово!");
    }

    function stereoWav(l, r) {
        const b = new ArrayBuffer(44 + l.length * 4);
        const v = new DataView(b);
        const s = (o, t) => { for (let i = 0; i < t.length; i++) v.setUint8(o + i, t.charCodeAt(i)); };
        s(0, 'RIFF'); v.setUint32(4, 36 + l.length * 4, true);
        s(8, 'WAVE'); s(12, 'fmt '); v.setUint32(16, 16, true);
        v.setUint16(20, 1, true); v.setUint16(22, 2, true);
        v.setUint32(24, 44100, true); v.setUint32(28, 176400, true);
        v.setUint16(32, 4, true); v.setUint16(34, 16, true);
        s(36, 'data'); v.setUint32(40, l.length * 4, true);
        for (let i = 0; i < l.length; i++) {
            v.setInt16(44 + i * 4, Math.max(-1, Math.min(1, l[i])) * 32767, true);
            v.setInt16(44 + i * 4 + 2, Math.max(-1, Math.min(1, r[i])) * 32767, true);
        }
        return new Blob([b], { type: 'audio/wav' });
    }

    async function startConversion() {
        const f = convFile.files[0]; if(!f) return;
        const mode = convMode.value;
        if(mode === 'j2r') {
            const d = JSON.parse(await f.text());
            const p1 = (d.inputs || d.events).filter(e => !(e.p2 || e.player === 2));
            const p2 = (d.inputs || d.events).filter(e => (e.p2 || e.player === 2));
            const buf = new ArrayBuffer(20 + (p1.length+p2.length)*48);
            const v = new DataView(buf);
            v.setFloat32(0, d.framerate || 240, true);
            v.setUint32(4, p1.length, true); v.setUint32(8, p2.length, true); v.setUint32(12, p1.length+p2.length, true);
            let body = 20 + (p1.length+p2.length)*32;
            [...p1, ...p2].forEach((e, i) => {
                v.setUint32(body+(i*16), e.frame || e.f, true);
                v.setUint8(body+(i*16)+4, (e.down || e.d)?1:0);
                v.setUint8(body+(i*16)+5, (e.p2 || e.player === 2)?1:0);
            });
            downloadBlob(new Blob([buf]), f.name.split('.')[0] + ".re3");
        }
    }

    function downloadBlob(b, n) { const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = n; a.click(); }
    function checkReady() { if(audioCache.clicks.length && macroEvents.length) renderBtn.style.display = 'block'; }
    
    async function loadMainPack(f, b) {
        document.querySelectorAll('.pack-btn').forEach(x => x.classList.remove('active')); b.classList.add('active');
        addLog("Загрузка " + f + "...");
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/clicks/${f}`);
        const files = await res.json();
        audioCache = { clicks: [], releases: [] };
        for (let file of files) {
            const ad = await ctx.decodeAudioData(await (await fetch(file.download_url)).arrayBuffer());
            if (file.name.toLowerCase().includes('click')) audioCache.clicks.push(ad.getChannelData(0));
            else audioCache.releases.push(ad.getChannelData(0));
        }
        addLog("Пак " + f + " готов."); checkReady();
    }

    async function init() {
        const r = await fetch(`https://api.github.com/repos/${REPO}/contents/packs`);
        const files = await r.json();
        const sel = document.getElementById('packSelect');
        sel.innerHTML = '<option disabled selected>ZIP из облака...</option>';
        files.filter(f => f.name.endsWith('.zip')).forEach(f => {
            const name = f.name.replace('.zip', '');
            const opt = document.createElement('option'); opt.value = name; opt.innerText = name.toUpperCase();
            sel.appendChild(opt);
        });
    }
    window.onload = init;
</script>
</body>
</html>
