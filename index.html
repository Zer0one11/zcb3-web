<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zcb3 WEB v10.0 - Full Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --accent: #00ff7f; --bg: #0b0b0e; --card: #121217; --border: #22222b; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', -apple-system, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        .container { background: var(--card); border: 1px solid var(--border); border-radius: 28px; padding: 35px; width: 100%; max-width: 500px; box-shadow: 0 40px 80px rgba(0,0,0,0.9); position: relative; overflow: hidden; }
        
        /* Шестеренка */
        .settings-trigger { position: absolute; top: 30px; right: 30px; cursor: pointer; z-index: 10; width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .settings-trigger:hover { transform: rotate(180deg) scale(1.1); }
        .settings-trigger svg { fill: #000; width: 24px; height: 24px; }

        h1 { color: var(--accent); font-size: 26px; text-align: center; text-transform: uppercase; margin: 0 0 30px 0; letter-spacing: 5px; font-weight: 900; }
        
        label { display: block; font-size: 11px; color: #555; margin-bottom: 10px; text-transform: uppercase; font-weight: 800; letter-spacing: 2px; }
        
        /* Паки */
        .main-packs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .pack-btn { background: #1a1a20; border: 1px solid var(--border); color: #888; padding: 18px; border-radius: 16px; cursor: pointer; font-weight: 700; transition: 0.3s; font-size: 13px; }
        .pack-btn.active { background: rgba(0,255,127,0.1); border-color: var(--accent); color: var(--accent); box-shadow: 0 0 15px rgba(0,255,127,0.1); }
        
        select { width: 100%; background: #1a1a20; color: #fff; border: 1px solid var(--border); padding: 16px; border-radius: 14px; margin-bottom: 30px; outline: none; font-weight: 600; cursor: pointer; }
        
        /* Зона сброса */
        .drop-zone { border: 2px dashed #333; padding: 50px 20px; text-align: center; border-radius: 22px; cursor: pointer; color: #666; margin-bottom: 25px; transition: 0.3s; font-weight: 700; text-transform: uppercase; font-size: 12px; }
        .drop-zone.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,127,0.05); border-style: solid; }
        
        /* Логи и Прогресс */
        .status-box { padding: 18px; background: #08080a; border-radius: 16px; font-family: 'Fira Code', monospace; font-size: 11px; color: var(--accent); border: 1px solid #1a1a1f; margin-bottom: 25px; white-space: pre-wrap; min-height: 50px; }
        
        .progress-wrapper { height: 6px; background: #1a1a20; border-radius: 10px; margin-bottom: 25px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; width: 0%; background: var(--accent); transition: 0.2s; box-shadow: 0 0 10px var(--accent); }

        /* Кнопка рендера */
        .btn-go { width: 100%; background: var(--accent); color: #000; padding: 22px; border-radius: 18px; font-weight: 900; border: none; cursor: pointer; text-transform: uppercase; display: none; font-size: 16px; letter-spacing: 1px; transition: 0.3s; }
        .btn-go:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,255,127,0.2); }

        /* Модалка настроек */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card); border: 1px solid var(--border); padding: 35px; border-radius: 30px; width: 90%; max-width: 420px; }
        .setting-item { margin-bottom: 25px; }
        input[type="range"] { width: 100%; accent-color: var(--accent); height: 6px; border-radius: 5px; cursor: pointer; margin-top: 10px; }

        /* Превью */
        .preview { margin-top: 30px; border-top: 1px solid #222; padding-top: 25px; display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        audio { width: 100%; filter: invert(1) hue-rotate(180deg); }
        .download-link { display: block; text-align: center; color: var(--accent); font-size: 13px; margin-top: 15px; font-weight: 800; text-decoration: none; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="container">
    <div class="settings-trigger" onclick="toggleModal(true)">
        <svg viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5A3.5 3.5 0 0 1 15.5 12A3.5 3.5 0 0 1 12 15.5M19.43 12.97C19.47 12.65 19.5 12.33 19.5 12C19.5 11.67 19.47 11.34 19.43 11L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.97 19.05 5.05L16.56 6.05C16.04 5.65 15.48 5.32 14.87 5.07L14.49 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.51 2.42L9.13 5.07C8.52 5.32 7.96 5.66 7.44 6.05L4.95 5.05C4.73 4.97 4.46 5.05 4.34 5.27L2.34 8.73C2.21 8.95 2.27 9.22 2.46 9.37L4.57 11C4.53 11.34 4.5 11.67 4.5 12C4.5 12.33 4.53 12.65 4.57 12.97L2.46 14.63C2.27 14.78 2.21 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.03 4.95 18.95L7.44 17.95C7.96 18.34 8.52 18.68 9.13 18.93L9.51 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.49 21.58L14.87 18.93C15.48 18.67 16.04 18.34 16.56 17.95L19.05 18.95C19.27 19.03 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.97Z"/></svg>
    </div>
    
    <h1>zcb3 WEB</h1>
    
    <label>Выберите пак кликов:</label>
    <div class="main-packs">
        <button class="pack-btn" onclick="loadMainPack('g502', this)">G502 Hero</button>
        <button class="pack-btn" onclick="loadMainPack('Viper-8K', this)">Viper 8K</button>
    </div>

    <select id="packSelect" onchange="loadZipPack(this.value)"><option>Загрузка архивов...</option></select>

    <label>Ваш макрос:</label>
    <div class="drop-zone" onclick="document.getElementById('macroInput').click()" id="dropZone">НАЖМИТЕ ИЛИ ПЕРЕТАЩИТЕ ФАЙЛ</div>
    <input type="file" id="macroInput" style="display: none;" onchange="handleMacro(this.files[0])">

    <div class="status-box" id="log">Ожидание данных...</div>
    
    <div class="progress-wrapper" id="progWrap"><div class="progress-bar" id="progBar"></div></div>

    <button id="renderBtn" class="btn-go" onclick="renderAudio()">Собрать Аудио</button>

    <div class="preview" id="previewArea">
        <audio id="player" controls></audio>
        <a id="download" class="download-link" href="#" download="render.wav">СКАЧАТЬ WAV</a>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <span style="float:right; cursor:pointer; font-size:24px;" onclick="toggleModal(false)">×</span>
        <h2 style="color:var(--accent); font-size:20px; margin-top:0; letter-spacing:2px;">НАСТРОЙКИ</h2>
        
        <div class="setting-item">
            <label>Общая громкость: <span id="volVal" style="float:right; color:var(--accent)">100%</span></label>
            <input type="range" id="volRange" min="0" max="200" value="100" oninput="volVal.innerText = this.value + '%'">
        </div>

        <div class="setting-item">
            <label>Смещение (Offset): <span id="offVal" style="float:right; color:var(--accent)">-140ms</span></label>
            <input type="range" id="offRange" min="-500" max="500" value="-140" oninput="offVal.innerText = this.value + 'ms'">
        </div>

        <div class="setting-item">
            <label>Загрузить свой ZIP:</label>
            <button onclick="document.getElementById('zipInput').click()" style="width:100%; padding:15px; background:var(--accent); border:none; border-radius:12px; font-weight:900; cursor:pointer; margin-top:10px;">ВЫБРАТЬ АРХИВ</button>
            <input type="file" id="zipInput" style="display: none;" accept=".zip" onchange="loadCustomZip(this.files[0])">
        </div>
    </div>
</div>

<script>
    const REPO = "Zer0one11/zcb3-web";
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let audioCache = { clicks: [], releases: [] }, macroEvents = [], currentTps = 240;

    function addLog(m) { log.innerText = "> " + m; }
    function toggleModal(s) { document.getElementById('settingsModal').style.display = s ? 'flex' : 'none'; }
    function updateProg(p) { progWrap.style.display = 'block'; progBar.style.width = p + '%'; }

    async function handleMacro(file) {
        if(!file) return;
        const buf = await file.arrayBuffer();
        const v = new DataView(buf);
        macroEvents = [];

        if(file.name.endsWith('.re3')) {
            currentTps = v.getFloat32(0, true);
            const p1Block = v.getUint32(4, true);
            const p2Block = v.getUint32(8, true);
            const total = v.getUint32(12, true);
            let offset = 20 + (p1Block + p2Block) * 32;

            for(let i=0; i < total; i++) {
                if (offset + 16 > buf.byteLength) break;
                macroEvents.push({
                    f: v.getUint32(offset, true),
                    d: v.getUint8(offset + 4) > 0,
                    p2: v.getUint8(offset + 5) !== 0
                });
                offset += 16;
            }
            macroEvents.sort((a, b) => a.f - b.f);
        } else {
            const d = JSON.parse(new TextDecoder().decode(buf));
            currentTps = d.framerate || 240;
            const evs = d.inputs || d.events || [];
            macroEvents = evs.map(e => ({
                f: e.frame ?? e.f,
                d: e.down ?? e.d,
                p2: e.p2 === true || e.player === 2
            })).sort((a,b) => a.f - b.f);
        }

        const p1 = macroEvents.filter(e => !e.p2 && e.d).length;
        const p2 = macroEvents.filter(e => e.p2 && e.d).length;
        addLog(`МАКРОС: ${file.name}\nTPS: ${currentTps}\n1P: ${p1} | 2P: ${p2}\nСортировка завершена.`);
        dropZone.innerText = file.name; dropZone.classList.add('active');
        checkReady();
    }

    async function renderAudio() {
        if(!macroEvents.length) return;
        updateProg(10);
        const vol = volRange.value / 100;
        const off = Math.floor((parseInt(offRange.value) / 1000) * 44100);
        const lastF = macroEvents[macroEvents.length-1].f;
        const totalSamples = Math.floor((lastF / currentTps) * 44100) + 88200;
        
        const L = new Float32Array(totalSamples);
        const R = new Float32Array(totalSamples);

        for(let i=0; i<macroEvents.length; i++) {
            const ev = macroEvents[i];
            const start = Math.floor((ev.f / currentTps) * 44100) + off;
            if (start < 0) continue;
            
            const pool = ev.d ? audioCache.clicks : audioCache.releases;
            if (pool.length) {
                const sample = pool[Math.floor(Math.random() * pool.length)];
                const pL = ev.p2 ? 0.3 : 1.0; 
                const pR = ev.p2 ? 1.0 : 0.3;
                for (let j = 0; j < sample.length && (start + j) < totalSamples; j++) {
                    L[start+j] += sample[j] * vol * pL;
                    R[start+j] += sample[j] * vol * pR;
                }
            }
            if(i % 100 === 0) updateProg(10 + (i/macroEvents.length)*80);
        }
        
        const wav = createWav(L, R);
        player.src = URL.createObjectURL(wav);
        download.href = player.src;
        previewArea.style.display = 'block';
        updateProg(100);
        setTimeout(() => progWrap.style.display = 'none', 1000);
    }

    function createWav(l, r) {
        const b = new ArrayBuffer(44 + l.length * 4);
        const v = new DataView(b);
        const s = (o, t) => { for (let i = 0; i < t.length; i++) v.setUint8(o + i, t.charCodeAt(i)); };
        s(0, 'RIFF'); v.setUint32(4, 36 + l.length * 4, true);
        s(8, 'WAVE'); s(12, 'fmt '); v.setUint32(16, 16, true);
        v.setUint16(20, 1, true); v.setUint16(22, 2, true);
        v.setUint32(24, 44100, true); v.setUint32(28, 176400, true);
        v.setUint16(32, 4, true); v.setUint16(34, 16, true);
        s(36, 'data'); v.setUint32(40, l.length * 4, true);
        for (let i = 0; i < l.length; i++) {
            v.setInt16(44 + i * 4, Math.max(-1, Math.min(1, l[i])) * 32767, true);
            v.setInt16(44 + i * 4 + 2, Math.max(-1, Math.min(1, r[i])) * 32767, true);
        }
        return new Blob([b], { type: 'audio/wav' });
    }

    async function loadMainPack(folder, btn) {
        document.querySelectorAll('.pack-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        addLog(`Загрузка ${folder}...`);
        audioCache = { clicks: [], releases: [] };
        const r = await fetch(`https://api.github.com/repos/${REPO}/contents/clicks/${folder}`);
        const files = await r.json();
        for (const f of files) {
            const ab = await (await fetch(f.download_url)).arrayBuffer();
            const ad = await ctx.decodeAudioData(ab);
            if (f.name.toLowerCase().includes('click')) audioCache.clicks.push(ad.getChannelData(0));
            else audioCache.releases.push(ad.getChannelData(0));
        }
        addLog(`Пак ${folder} готов.`); checkReady();
    }

    async function loadZipPack(name) {
        addLog(`Загрузка архива ${name}...`);
        const url = `https://raw.githubusercontent.com/${REPO}/main/packs/${name}.zip`;
        const res = await fetch(url);
        loadCustomZip(await res.blob());
    }

    async function loadCustomZip(file) {
        if(!file) return;
        addLog("Распаковка ZIP...");
        audioCache = { clicks: [], releases: [] };
        const zip = await JSZip.loadAsync(file);
        for (let name in zip.files) {
            if (name.endsWith('.wav')) {
                const data = await zip.files[name].async("arraybuffer");
                const decoded = await ctx.decodeAudioData(data);
                if (name.toLowerCase().includes('click')) audioCache.clicks.push(decoded.getChannelData(0));
                else audioCache.releases.push(decoded.getChannelData(0));
            }
        }
        addLog(`ZIP загружен: ${audioCache.clicks.length} кликов`);
        checkReady();
    }

    function checkReady() { if(audioCache.clicks.length && macroEvents.length) renderBtn.style.display = 'block'; }
    
    async function init() {
        try {
            const r = await fetch(`https://api.github.com/repos/${REPO}/contents/packs`);
            const files = await r.json();
            const sel = document.getElementById('packSelect');
            sel.innerHTML = '<option value="" disabled selected>Или выберите ZIP из списка...</option>';
            files.filter(f => f.name.endsWith('.zip')).forEach(f => {
                const name = f.name.replace('.zip', '');
                const opt = document.createElement('option');
                opt.value = name; opt.innerText = name.toUpperCase();
                sel.appendChild(opt);
            });
        } catch(e) { addLog("Ошибка сети при загрузке паков."); }
    }
    window.onload = init;
</script>
</body>
</html>

