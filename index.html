<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>zcb3 WEB - Block Sorter 8.0</title>
    <style>
        :root { --accent: #00ff7f; --bg: #0b0b0e; --card: #121217; --border: #22222b; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 30px; width: 100%; max-width: 450px; text-align: center; }
        h1 { color: var(--accent); font-size: 20px; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 25px; }
        .drop-zone { border: 2px dashed #333; padding: 40px; border-radius: 20px; cursor: pointer; color: #666; margin-bottom: 20px; transition: 0.3s; }
        .drop-zone.active { border-color: var(--accent); background: rgba(0,255,127,0.05); color: var(--accent); }
        .status { background: #08080a; padding: 15px; border-radius: 12px; font-family: monospace; font-size: 11px; color: var(--accent); text-align: left; margin-bottom: 20px; min-height: 60px; }
        .btn-main { width: 100%; background: var(--accent); color: #000; padding: 18px; border-radius: 12px; font-weight: 900; border: none; cursor: pointer; display: none; text-transform: uppercase; }
        .pack-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .p-btn { background: #1a1a20; border: 1px solid var(--border); color: #888; padding: 12px; border-radius: 10px; cursor: pointer; }
        .p-btn.active { border-color: var(--accent); color: var(--accent); }
        audio { width: 100%; margin-top: 20px; filter: invert(1); }
    </style>
</head>
<body>

<div class="container">
    <h1>zcb3 Block Sorter</h1>
    
    <div class="pack-grid">
        <button class="p-btn" onclick="loadPack('g502', this)">Logitech G502</button>
        <button class="p-btn" onclick="loadPack('Viper-8K', this)">Razer Viper 8K</button>
    </div>

    <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileIn').click()">ЗАГРУЗИТЬ RE3</div>
    <input type="file" id="fileIn" style="display:none" onchange="process(this.files[0])">

    <div class="status" id="st">Ожидание пака и файла...</div>
    
    <button id="go" class="btn-main" onclick="render()">СОЗДАТЬ АУДИО</button>
    <audio id="aud" controls style="display:none"></audio>
</div>

<script>
    const REPO = "Zer0one11/zcb3-web";
    let audioCache = { c: [], r: [] }, events = [], tps = 240;
    const actx = new AudioContext();

    async function process(file) {
        const buf = await file.arrayBuffer();
        const v = new DataView(buf);
        events = [];

        tps = v.getFloat32(0, true);
        const p1BlockSize = v.getUint32(4, true); // Размер блока 1P
        const p2BlockSize = v.getUint32(8, true); // Размер блока 2P
        const totalEvents = v.getUint32(12, true);

        // Начало данных после заголовка и позиций
        let baseOffset = 20 + (p1BlockSize + p2BlockSize) * 32;

        // В RE3 часто события идут так: сначала N событий 1P, потом M событий 2P
        // Мы читаем их все подряд, но разделяем логику по счетчику
        for(let i = 0; i < totalEvents; i++) {
            let off = baseOffset + (i * 16);
            if (off + 16 > buf.byteLength) break;

            const frame = v.getUint32(off, true);
            const action = v.getUint8(off + 4);
            const pIdx = v.getUint8(off + 5); // 0 или 1

            // Определяем игрока: либо по флагу в байте, либо по позиции в списке
            // Но мы будем доверять флагу pIdx, если он есть
            events.push({
                f: frame,
                d: (action & 1) !== 0 || action > 0,
                p2: (pIdx === 1 || pIdx === 2)
            });
        }

        // КЛЮЧЕВОЙ МОМЕНТ: Сортировка по кадрам (то, что сказал разработчик)
        events.sort((a, b) => a.f - b.f);

        const p1 = events.filter(e => !e.p2 && e.d).length;
        const p2 = events.filter(e => e.p2 && e.d).length;

        st.innerText = `Файл: ${file.name}\nTPS: ${tps.toFixed(0)}\n1P клики: ${p1}\n2P клики: ${p2}\nСортировка завершена.`;
        dropZone.innerText = "ФАЙЛ ГОТОВ"; dropZone.classList.add('active');
        check();
    }

    async function render() {
        st.innerText = "Рендеринг стерео-потока...";
        const off = -6174; // -140ms
        const maxF = events[events.length-1].f;
        const len = Math.floor((maxF / tps) * 44100) + 88200;
        const L = new Float32Array(len), R = new Float32Array(len);

        events.forEach(e => {
            const start = Math.floor((e.f / tps) * 44100) + off;
            if (start < 0) return;
            const pool = e.d ? audioCache.c : audioCache.r;
            if (pool.length) {
                const s = pool[Math.floor(Math.random() * pool.length)];
                const panL = e.p2 ? 0.1 : 1.0;
                const panR = e.p2 ? 1.0 : 0.1;
                for (let j = 0; j < s.length && (start + j) < len; j++) {
                    L[start+j] += s[j] * panL; R[start+j] += s[j] * panR;
                }
            }
        });

        const b = new ArrayBuffer(44 + L.length * 4);
        const v = new DataView(b);
        const s = (o, t) => { for (let i = 0; i < t.length; i++) v.setUint8(o + i, t.charCodeAt(i)); };
        s(0, 'RIFF'); v.setUint32(4, 36 + L.length * 4, true);
        s(8, 'WAVE'); s(12, 'fmt '); v.setUint32(16, 16, true);
        v.setUint16(20, 1, true); v.setUint16(22, 2, true);
        v.setUint32(24, 44100, true); v.setUint32(28, 176400, true);
        v.setUint16(32, 4, true); v.setUint16(34, 16, true);
        s(36, 'data'); v.setUint32(40, L.length * 4, true);
        for (let i = 0; i < L.length; i++) {
            v.setInt16(44 + i * 4, Math.max(-1, Math.min(1, L[i])) * 32767, true);
            v.setInt16(44 + i * 4 + 2, Math.max(-1, Math.min(1, R[i])) * 32767, true);
        }
        aud.src = URL.createObjectURL(new Blob([b], {type:'audio/wav'}));
        aud.style.display = 'block'; st.innerText = "Готово! 1P - Слева, 2P - Справа.";
    }

    async function loadPack(p, btn) {
        document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        st.innerText = "Загрузка пака...";
        audioCache = { c: [], r: [] };
        const res = await (await fetch(`https://api.github.com/repos/${REPO}/contents/clicks/${p}`)).json();
        for (let f of res) {
            const b = await actx.decodeAudioData(await (await fetch(f.download_url)).arrayBuffer());
            if (f.name.includes('click')) audioCache.c.push(b.getChannelData(0));
            else audioCache.r.push(b.getChannelData(0));
        }
        st.innerText = "Пак загружен."; check();
    }

    function check() { if(events.length && audioCache.c.length) go.style.display = 'block'; }
</script>
</body>
</html>

