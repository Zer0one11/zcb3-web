<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>zcb3 WEB - Final</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --accent: #00ff7f; --bg: #0d0d10; }
        body { background: var(--bg); color: #e1e1e1; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: #16161e; border: 1px solid #2a2a35; border-radius: 16px; padding: 25px; width: 100%; max-width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        h1 { color: var(--accent); font-size: 18px; text-align: center; text-transform: uppercase; margin-bottom: 20px; letter-spacing: 2px; }
        
        label { display: block; font-size: 10px; color: #666; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; }
        select { width: 100%; background: #000; color: var(--accent); border: 1px solid #333; padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; outline: none; }
        
        .drop-zone { border: 2px dashed #333; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; color: #888; transition: 0.3s; margin-bottom: 20px; }
        .drop-zone:hover { border-color: var(--accent); color: #fff; }
        .drop-zone.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,127,0.05); }

        input[type="range"] { width: 100%; accent-color: var(--accent); margin-bottom: 20px; }
        .status { padding: 12px; background: #050505; border-radius: 5px; font-family: monospace; font-size: 11px; height: 60px; overflow-y: auto; color: #00ff7f; border: 1px solid #1a1a1a; margin-bottom: 20px; }
        
        .btn { width: 100%; background: var(--accent); color: #000; padding: 15px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; text-transform: uppercase; display: none; }
        .preview { margin-top: 20px; display: none; border-top: 1px solid #333; padding-top: 20px; text-align: center; }
        audio { width: 100%; filter: invert(1); margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>zcb3 WEB</h1>
    
    <label>Клик-пак:</label>
    <select id="packSelect" onchange="loadZip(this.value)"></select>

    <label>Макрос (.json):</label>
    <div class="drop-zone" onclick="document.getElementById('macroFile').click()" id="dropZone">ВЫБРАТЬ МАКРОС</div>
    <input type="file" id="macroFile" style="display: none;" accept=".json" onchange="handleMacro(this.files[0])">

    <label>Громкость: <span id="vLab" style="float:right">100%</span></label>
    <input type="range" id="vol" min="0" max="200" value="100" oninput="vLab.innerText=this.value+'%'">

    <div class="status" id="log">Ожидание...</div>

    <button id="goBtn" class="btn" onclick="render()">ОБРАБОТАТЬ</button>

    <div class="preview" id="pre">
        <audio id="player" controls></audio>
        <a id="dl" href="#" style="color:var(--accent); text-decoration:none; font-size:12px">СКАЧАТЬ РЕЗУЛЬТАТ (.WAV)</a>
    </div>
</div>

<script>
    // Список твоих файлов (без .zip)
    const allPacks = [
        "andarian-g502-hero",
        "razer-deathadder-elite",
        "logitech-g-pro-x-superlight-mouse",
        "average-mouse-click",
        "clicks2",
        "zoink-click-pack",
        "zoinks-wooting-80he"
    ];

    let audioCache = { clicks: [], releases: [] }, macro = [], tps = 240;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();

    // Инициализация списка
    const sel = document.getElementById('packSelect');
    allPacks.forEach(p => {
        const o = document.createElement('option');
        o.value = p; o.innerText = p.replace(/-/g, ' ').toUpperCase();
        sel.appendChild(o);
    });

    function addLog(t) { log.innerText = "> " + t; }

    async function loadZip(name) {
        addLog(`Загрузка ${name}...`);
        audioCache = { clicks: [], releases: [] };
        try {
            const res = await fetch(`packs/${name}.zip`);
            const zip = await JSZip.loadAsync(await res.blob());
            const promises = [];

            zip.forEach((path, file) => {
                const lp = path.toLowerCase();
                if (!file.dir && (lp.endsWith('.wav') || lp.endsWith('.ogg'))) {
                    const isC = lp.includes('click');
                    const isR = lp.includes('rel');
                    if (isC || isR) {
                        promises.push(file.async("arraybuffer").then(async data => {
                            const buf = await ctx.decodeAudioData(data);
                            if (isC) audioCache.clicks.push(buf); else audioCache.releases.push(buf);
                        }));
                    }
                }
            });
            await Promise.all(promises);
            addLog(`Пак готов! (C:${audioCache.clicks.length} R:${audioCache.releases.length})`);
            check();
        } catch(e) { addLog("Ошибка загрузки пака"); }
    }

    async function handleMacro(f) {
        if(!f) return;
        const d = JSON.parse(await f.text());
        macro = (d.inputs || d.events).map(e => ({ f: e.frame ?? e.f, d: e.down ?? e.d }));
        tps = d.framerate || 240;
        dropZone.innerText = "✅ " + f.name;
        dropZone.classList.add('active');
        check();
    }

    function check() { if(audioCache.clicks.length && macro.length) goBtn.style.display = 'block'; }

    async function render() {
        addLog("Рендеринг...");
        const v = vol.value / 100;
        const dur = (macro[macro.length-1].f / tps) + 1.5;
        const oCtx = new OfflineAudioContext(1, 44100 * dur, 44100);

        macro.forEach(e => {
            const p = e.d ? audioCache.clicks : audioCache.releases;
            if(p.length) {
                const s = oCtx.createBufferSource();
                s.buffer = p[Math.floor(Math.random()*p.length)];
                const g = oCtx.createGain();
                g.gain.value = (0.8 + Math.random()*0.2) * v;
                s.connect(g); g.connect(oCtx.destination);
                s.start(e.f / tps);
            }
        });

        const res = await oCtx.startRendering();
        const url = URL.createObjectURL(bufferToWav(res));
        player.src = url; dl.href = url; dl.download = "clicks.wav";
        pre.style.display = 'block';
        addLog("Готово!");
    }

    function bufferToWav(ab) {
        const n=1, len=ab.length*2+44, b=new ArrayBuffer(len), v=new DataView(b);
        const s=(o,t)=>{for(let i=0;i<t.length;i++)v.setUint8(o+i,t.charCodeAt(i))};
        s(0,'RIFF'); v.setUint32(4,len-8,true); s(8,'WAVE'); s(12,'fmt ');
        v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,n,true);
        v.setUint32(24,44100,true); v.setUint32(28,88200,true); v.setUint16(32,2,true);
        v.setUint16(34,16,true); s(36,'data'); v.setUint32(40,len-44,true);
        const d=ab.getChannelData(0);
        for(let i=0;i<d.length;i++){let x=Math.max(-1,Math.min(1,d[i]));v.setInt16(44+i*2,x<0?x*32768:x*32767,true)}
        return new Blob([b], {type:'audio/wav'});
    }

    // Авто-загрузка первого пака при старте
    window.onload = () => loadZip(allPacks[0]);
</script>
</body>
</html>
