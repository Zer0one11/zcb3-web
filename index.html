<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>zcb3 WEB - ZIP Manual</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --accent: #00ff7f; --bg: #0d0d10; }
        body { background: var(--bg); color: #e1e1e1; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { background: #16161e; border: 1px solid #2a2a35; border-radius: 16px; padding: 25px; width: 100%; max-width: 450px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        h1 { color: var(--accent); font-size: 20px; text-align: center; text-transform: uppercase; margin-top: 0; letter-spacing: 2px; }
        
        .section-label { display: block; font-size: 10px; color: #666; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; }
        
        .upload-area { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .btn-upload { background: #1a1a24; color: #fff; border: 1px dashed #444; padding: 15px; border-radius: 10px; cursor: pointer; text-align: center; transition: 0.3s; }
        .btn-upload:hover { border-color: var(--accent); background: #222; }
        .btn-upload.loaded { border-style: solid; border-color: var(--accent); color: var(--accent); }

        .control-group { margin: 15px 0; background: #000; padding: 15px; border-radius: 8px; border: 1px solid #222; }
        .status-box { margin-top: 15px; padding: 12px; background: #050505; border-radius: 5px; font-family: 'Consolas', monospace; font-size: 11px; height: 100px; overflow-y: auto; color: #00ff7f; border: 1px solid #1a1a1a; }
        
        .btn-main { display: none; background: var(--accent); color: #000; padding: 15px; border-radius: 8px; font-weight: bold; margin-top: 10px; width: 100%; border: none; cursor: pointer; text-transform: uppercase; }
        
        .preview-section { margin-top: 20px; display: none; border-top: 1px solid #333; padding-top: 20px; }
        audio { width: 100%; filter: invert(100%) hue-rotate(180deg); margin-bottom: 10px; }
        
        .footer { margin-top: 25px; text-align: center; font-size: 12px; color: #444; }
    </style>
</head>
<body>

<div class="container">
    <h1>zcb3 WEB</h1>
    
    <div class="upload-area">
        <span class="section-label">1. –ó–ê–ì–†–£–ó–ò–¢–ï –§–ê–ô–õ–´</span>
        <div id="zipBtn" class="btn-upload" onclick="document.getElementById('zipInput').click()">üìÅ –í–´–ë–†–ê–¢–¨ ZIP (–ö–õ–ò–ö-–ü–ê–ö)</div>
        <div id="macroBtn" class="btn-upload" onclick="document.getElementById('macroInput').click()">üìù –í–´–ë–†–ê–¢–¨ JSON (–ú–ê–ö–†–û–°)</div>
    </div>

    <input type="file" id="zipInput" style="display: none;" accept=".zip" onchange="handleZip(this.files[0])">
    <input type="file" id="macroInput" style="display: none;" accept=".json" onchange="handleMacro(this.files[0])">

    <div class="control-group">
        <label class="section-label">–ì–†–û–ú–ö–û–°–¢–¨: <span id="volVal" style="float:right; color:var(--accent)">100%</span></label>
        <input type="range" id="volumeRange" min="0" max="300" value="100" style="width:100%; accent-color:var(--accent)" oninput="volVal.innerText=this.value+'%'">
    </div>

    <div class="status-box" id="log">–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤...</div>

    <button id="renderBtn" class="btn-main" onclick="renderAudio()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–≤—É–∫</button>

    <div class="preview-section" id="previewSection">
        <audio id="audioPlayer" controls></audio>
        <a id="downloadBtn" href="#" class="btn-main" style="display:block; background:#fff; text-decoration:none; text-align:center">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</a>
    </div>

    <div class="footer">Made by HELFZz</div>
</div>

<script>
    let audioCache = { clicks: [], releases: [] };
    let macroEvents = [];
    let currentTps = 240;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function addLog(t) {
        const b = document.getElementById('log');
        b.innerText += `\n> ${t}`;
        b.scrollTop = b.scrollHeight;
    }

    async function handleZip(file) {
        if (!file) return;
        addLog(`–†–∞—Å–ø–∞–∫–æ–≤–∫–∞: ${file.name}`);
        audioCache = { clicks: [], releases: [] };
        
        try {
            const zip = await JSZip.loadAsync(file);
            const tasks = [];

            zip.forEach((path, zipEntry) => {
                const lowPath = path.toLowerCase();
                const isAudio = lowPath.endsWith('.ogg') || lowPath.endsWith('.wav') || lowPath.endsWith('.mp3');
                
                if (!zipEntry.dir && isAudio) {
                    const isClick = lowPath.includes('click');
                    const isRel = lowPath.includes('release');
                    
                    if (isClick || isRel) {
                        const t = zipEntry.async("arraybuffer").then(async (data) => {
                            try {
                                const buffer = await audioCtx.decodeAudioData(data);
                                if (isClick) audioCache.clicks.push(buffer);
                                else audioCache.releases.push(buffer);
                            } catch(e) { console.warn("–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:", path); }
                        });
                        tasks.push(t);
                    }
                }
            });

            await Promise.all(tasks);
            
            if (audioCache.clicks.length > 0) {
                document.getElementById('zipBtn').innerText = `‚úÖ –ü–ê–ö: ${file.name}`;
                document.getElementById('zipBtn').classList.add('loaded');
                addLog(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–ª–∏–∫–æ–≤: ${audioCache.clicks.length}, —Ä–µ–ª–∏–∑–æ–≤: ${audioCache.releases.length}`);
                checkReady();
            } else {
                addLog("–û—à–∏–±–∫–∞: –í ZIP –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–∞–ø–∫–∏ Clicks –∏–ª–∏ Releases!");
            }
        } catch (e) { addLog("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ ZIP –∞—Ä—Ö–∏–≤–∞."); }
    }

    async function handleMacro(file) {
        if (!file) return;
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            macroEvents = [];
            currentTps = data.framerate || 240;
            const events = data.inputs || data.events || [];
            
            events.forEach(e => {
                macroEvents.push({ f: e.frame ?? e.f, d: e.down ?? e.d });
            });

            document.getElementById('macroBtn').innerText = `‚úÖ –ú–ê–ö–†–û–°: ${file.name}`;
            document.getElementById('macroBtn').classList.add('loaded');
            addLog(`–ú–∞–∫—Ä–æ—Å –æ–∫! –°–æ–±—ã—Ç–∏–π: ${macroEvents.length}`);
            checkReady();
        } catch (e) { addLog("–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON –º–∞–∫—Ä–æ—Å–∞."); }
    }

    function checkReady() {
        if (audioCache.clicks.length > 0 && macroEvents.length > 0) {
            document.getElementById('renderBtn').style.display = 'block';
        }
    }

    async function renderAudio() {
        const vol = parseInt(document.getElementById('volumeRange').value) / 100;
        const lastEvent = macroEvents[macroEvents.length - 1];
        const duration = (lastEvent.f / currentTps) + 1.5;
        
        addLog("–†–µ–Ω–¥–µ—Ä–∏–Ω–≥...");
        const offlineCtx = new OfflineAudioContext(1, 44100 * duration, 44100);

        macroEvents.forEach(ev => {
            const time = ev.f / currentTps;
            const pool = ev.d ? audioCache.clicks : audioCache.releases;
            
            if (pool && pool.length > 0) {
                const source = offlineCtx.createBufferSource();
                source.buffer = pool[Math.floor(Math.random() * pool.length)];
                
                const gain = offlineCtx.createGain();
                gain.gain.value = (0.8 + Math.random() * 0.2) * vol;
                
                source.connect(gain);
                gain.connect(offlineCtx.destination);
                source.start(time);
            }
        });

        const renderedBuffer = await offlineCtx.startRendering();
        const wavBlob = bufferToWav(renderedBuffer);
        const url = URL.createObjectURL(wavBlob);
        
        document.getElementById('audioPlayer').src = url;
        document.getElementById('downloadBtn').href = url;
        document.getElementById('downloadBtn').download = "clicks_render.wav";
        document.getElementById('previewSection').style.display = 'block';
        addLog("–ì–æ—Ç–æ–≤–æ! –°–ª—É—à–∞–π—Ç–µ –∏–ª–∏ —Å–∫–∞—á–∏–≤–∞–π—Ç–µ.");
    }

    function bufferToWav(ab) {
        const n=1, len=ab.length*2+44, b=new ArrayBuffer(len), v=new DataView(b);
        const s=(o,t)=>{for(let i=0;i<t.length;i++)v.setUint8(o+i,t.charCodeAt(i))};
        s(0,'RIFF'); v.setUint32(4,len-8,true); s(8,'WAVE'); s(12,'fmt ');
        v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,n,true);
        v.setUint32(24,44100,true); v.setUint32(28,88200,true); v.setUint16(32,2,true);
        v.setUint16(34,16,true); s(36,'data'); v.setUint32(40,len-44,true);
        const d=ab.getChannelData(0);
        for(let i=0;i<d.length;i++){let x=Math.max(-1,Math.min(1,d[i]));v.setInt16(44+i*2,x<0?x*32768:x*32767,true)}
        return new Blob([b], {type:'audio/wav'});
    }
</script>
</body>
</html>
