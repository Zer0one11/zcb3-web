<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>zcb3 WEB - Classic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --accent: #00ff7f; --bg: #0d0d10; }
        body { background: var(--bg); color: #e1e1e1; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #16161e; border: 1px solid #2a2a35; border-radius: 16px; padding: 25px; width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        h1 { color: var(--accent); font-size: 18px; text-align: center; text-transform: uppercase; margin-bottom: 20px; letter-spacing: 2px; }
        
        select, .btn-action { width: 100%; background: #000; color: var(--accent); border: 1px solid #333; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; outline: none; margin-bottom: 15px; }
        .btn-action { background: var(--accent); color: #000; border: none; display: none; margin-top: 10px; }
        
        .drop-zone { border: 2px dashed #333; padding: 25px; text-align: center; border-radius: 10px; cursor: pointer; color: #888; transition: 0.3s; }
        .drop-zone:hover { border-color: var(--accent); color: #fff; }

        .controls { margin-top: 20px; background: #0a0a0f; padding: 15px; border-radius: 8px; }
        label { font-size: 10px; color: #555; text-transform: uppercase; display: block; margin-bottom: 5px; }
        input[type="range"] { width: 100%; accent-color: var(--accent); }
        
        .status { margin-top: 15px; font-size: 11px; color: #00ff7f; font-family: monospace; text-align: center; }
        .preview { margin-top: 20px; display: none; text-align: center; border-top: 1px solid #222; padding-top: 15px; }
        audio { width: 100%; filter: invert(1); }
    </style>
</head>
<body>

<div class="container">
    <h1>zcb3 WEB</h1>
    
    <label>Выберите пак:</label>
    <select id="packSelect" onchange="loadZip(this.value)">
        <option value="razer-deathadder-elite">Razer Deathadder</option>
        <option value="logitech-g-pro-x-superlight-mouse">Logitech G Pro X</option>
        <option value="zfxnts-g502-hero">Logitech G502</option>
        <option value="zoink-click-pack">Zoink Clickpack</option>
    </select>

    <div class="drop-zone" onclick="document.getElementById('macroInput').click()" id="dropZone">
        ВЫБРАТЬ МАКРОС (.JSON)
    </div>
    <input type="file" id="macroInput" style="display: none;" accept=".json" onchange="handleMacro(this.files[0])">

    <div class="controls">
        <label>Громкость</label>
        <input type="range" id="volRange" min="0" max="200" value="100">
    </div>

    <div class="status" id="status">Ожидание...</div>

    <button id="renderBtn" class="btn-action" onclick="renderAudio()">ОБРАБОТАТЬ</button>

    <div class="preview" id="preview">
        <audio id="player" controls></audio>
        <a id="download" style="color: var(--accent); text-decoration: none; font-size: 12px; display: block; margin-top: 10px;" href="#">СКАЧАТЬ WAV</a>
    </div>
</div>

<script>
    let audioCache = { clicks: [], releases: [] }, macroEvents = [], currentTps = 240;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();

    async function loadZip(name) {
        status.innerText = "Загрузка пака...";
        audioCache = { clicks: [], releases: [] };
        try {
            const res = await fetch(`packs/${name}.zip`);
            const zip = await JSZip.loadAsync(await res.blob());
            const tasks = [];

            zip.forEach((path, entry) => {
                if (!entry.dir && (path.toLowerCase().endsWith('.ogg') || path.toLowerCase().endsWith('.wav'))) {
                    const isClick = path.toLowerCase().includes('click');
                    tasks.push(entry.async("arraybuffer").then(async data => {
                        const buffer = await ctx.decodeAudioData(data);
                        if (isClick) audioCache.clicks.push(buffer);
                        else audioCache.releases.push(buffer);
                    }));
                }
            });
            await Promise.all(tasks);
            status.innerText = `Пак готов (C:${audioCache.clicks.length} R:${audioCache.releases.length})`;
        } catch (e) { status.innerText = "Ошибка загрузки ZIP"; }
    }

    async function handleMacro(file) {
        if (!file) return;
        const data = JSON.parse(await file.text());
        macroEvents = (data.inputs || data.events).map(e => ({ f: e.frame ?? e.f, d: e.down ?? e.d }));
        currentTps = data.framerate || 240;
        dropZone.innerText = "✅ " + file.name;
        renderBtn.style.display = "block";
    }

    async function renderAudio() {
        const vol = volRange.value / 100;
        const duration = (macroEvents[macroEvents.length - 1].f / currentTps) + 1.5;
        const oCtx = new OfflineAudioContext(1, 44100 * duration, 44100);

        macroEvents.forEach(ev => {
            const pool = ev.d ? audioCache.clicks : audioCache.releases;
            if (pool.length) {
                const s = oCtx.createBufferSource();
                s.buffer = pool[Math.floor(Math.random() * pool.length)];
                const g = oCtx.createGain();
                g.gain.value = (0.8 + Math.random() * 0.2) * vol;
                s.connect(g); g.connect(oCtx.destination);
                s.start(ev.f / currentTps);
            }
        });

        const rendered = await oCtx.startRendering();
        const url = URL.createObjectURL(bufferToWav(rendered));
        player.src = url;
        download.href = url;
        download.download = "result.wav";
        preview.style.display = "block";
        status.innerText = "Рендер завершен!";
    }

    function bufferToWav(ab) {
        const n=1, len=ab.length*2+44, b=new ArrayBuffer(len), v=new DataView(b);
        const s=(o,t)=>{for(let i=0;i<t.length;i++)v.setUint8(o+i,t.charCodeAt(i))};
        s(0,'RIFF'); v.setUint32(4,len-8,true); s(8,'WAVE'); s(12,'fmt ');
        v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,n,true);
        v.setUint32(24,44100,true); v.setUint32(28,88200,true); v.setUint16(32,2,true);
        v.setUint16(34,16,true); s(36,'data'); v.setUint32(40,len-44,true);
        const d=ab.getChannelData(0);
        for(let i=0;i<d.length;i++){let x=Math.max(-1,Math.min(1,d[i]));v.setInt16(44+i*2,x<0?x*32768:x*32767,true)}
        return new Blob([b], {type:'audio/wav'});
    }

    window.onload = () => loadZip(packSelect.value);
</script>
</body>
</html>
