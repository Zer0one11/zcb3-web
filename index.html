<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zcb3 WEB v11.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --accent: #00ff7f; --bg: #0b0b0e; --card: #121217; --border: #22222b; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: var(--card); border: 1px solid var(--border); border-radius: 28px; padding: 35px; width: 100%; max-width: 500px; box-shadow: 0 40px 80px rgba(0,0,0,0.9); position: relative; }
        
        .icon-btn { position: absolute; top: 30px; cursor: pointer; z-index: 10; width: 40px; height: 40px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; box-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .icon-btn:hover { transform: scale(1.1); }
        .icon-btn svg { fill: #000; width: 22px; height: 22px; }
        .settings-trigger { right: 30px; }
        .converter-trigger { left: 30px; }

        h1 { color: var(--accent); font-size: 26px; text-align: center; text-transform: uppercase; margin: 0 0 30px 0; letter-spacing: 5px; font-weight: 900; }
        label { display: block; font-size: 11px; color: #555; margin-bottom: 10px; text-transform: uppercase; font-weight: 800; letter-spacing: 2px; }
        
        .main-packs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .pack-btn { background: #1a1a20; border: 1px solid var(--border); color: #888; padding: 18px; border-radius: 16px; cursor: pointer; font-weight: 700; transition: 0.3s; }
        .pack-btn.active { background: rgba(0,255,127,0.1); border-color: var(--accent); color: var(--accent); }
        
        select, .conv-select { width: 100%; background: #1a1a20; color: #fff; border: 1px solid var(--border); padding: 16px; border-radius: 14px; margin-bottom: 20px; outline: none; }
        
        .drop-zone { border: 2px dashed #333; padding: 40px 20px; text-align: center; border-radius: 22px; cursor: pointer; color: #666; margin-bottom: 25px; transition: 0.3s; font-weight: 700; }
        .drop-zone.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,127,0.05); }
        
        .status-box { padding: 18px; background: #08080a; border-radius: 16px; font-family: monospace; font-size: 11px; color: var(--accent); border: 1px solid #1a1a1f; margin-bottom: 25px; white-space: pre-wrap; }
        
        .btn-go { width: 100%; background: var(--accent); color: #000; padding: 20px; border-radius: 18px; font-weight: 900; border: none; cursor: pointer; text-transform: uppercase; display: none; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card); border: 1px solid var(--border); padding: 35px; border-radius: 30px; width: 90%; max-width: 420px; position: relative; }
        
        .preview { margin-top: 30px; border-top: 1px solid #222; padding-top: 25px; display: none; }
        audio { width: 100%; filter: invert(1); }
    </style>
</head>
<body>

<div class="container">
    <div class="icon-btn converter-trigger" title="Конвертер" onclick="toggleConverter(true)">
        <svg viewBox="0 0 24 24"><path d="M12,18L8,14H11V7H13V14H16L12,18M20,2H4A2,2 0 0,0 2,4V20A2,2 0 0,0 4,22H20A2,2 0 0,0 22,20V4C22,2.89 21.1,2 20,2Z"/></svg>
    </div>

    <div class="icon-btn settings-trigger" title="Настройки" onclick="toggleSettings(true)">
        <svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.97 19.05,5.05L16.56,6.05C16.04,5.65 15.48,5.32 14.87,5.07L14.49,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.51,2.42L9.13,5.07C8.52,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.97 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.95C7.96,18.34 8.52,18.68 9.13,18.93L9.51,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.49,21.58L14.87,18.93C15.48,18.67 16.04,18.34 16.56,17.95L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg>
    </div>
    
    <h1>zcb3 WEB</h1>
    
    <label>Быстрые паки:</label>
    <div class="main-packs">
        <button class="pack-btn" onclick="loadMainPack('g502', this)">G502 Hero</button>
        <button class="pack-btn" onclick="loadMainPack('Viper-8K', this)">Viper 8K</button>
    </div>

    <select id="packSelect" onchange="loadZipPack(this.value)"><option>Загрузка облака...</option></select>

    <div class="drop-zone" onclick="document.getElementById('macroInput').click()" id="dropZone">БРОСЬТЕ .RE3 ИЛИ .JSON</div>
    <input type="file" id="macroInput" style="display: none;" onchange="handleMacro(this.files[0])">

    <div class="status-box" id="log">Готов к работе</div>
    <button id="renderBtn" class="btn-go" onclick="renderAudio()">Сгенерировать звук</button>

    <div class="preview" id="previewArea">
        <audio id="player" controls></audio>
        <a id="download" style="display:block; text-align:center; color:var(--accent); margin-top:10px; font-weight:bold;" href="#" download="render.wav">СКАЧАТЬ РЕЗУЛЬТАТ</a>
    </div>
</div>

<div class="modal" id="converterModal">
    <div class="modal-content">
        <span style="position:absolute; top:20px; right:20px; cursor:pointer; font-size:20px;" onclick="toggleConverter(false)">×</span>
        <h2 style="color:var(--accent); margin:0 0 20px 0;">MACRO CONVERTER</h2>
        
        <label>Направление:</label>
        <select class="conv-select" id="convMode">
            <option value="j2r">JSON → RE3 (GDH)</option>
            <option value="r2j">RE3 → JSON (xdBot)</option>
        </select>

        <label>Файл:</label>
        <input type="file" id="convFile" style="margin-bottom:20px; font-size:12px;">
        
        <button onclick="startConversion()" style="width:100%; padding:18px; background:var(--accent); border:none; border-radius:15px; font-weight:900; cursor:pointer;">ВЫПОЛНИТЬ</button>
        <div id="convStatus" style="font-size:11px; margin-top:15px; color:var(--accent); font-family:monospace; text-align:center;"></div>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <span style="position:absolute; top:20px; right:20px; cursor:pointer; font-size:20px;" onclick="toggleSettings(false)">×</span>
        <h2 style="color:var(--accent); margin:0 0 20px 0;">НАСТРОЙКИ</h2>
        
        <label>Громкость: <span id="volVal" style="float:right; color:var(--accent)">100%</span></label>
        <input type="range" id="volRange" min="0" max="200" value="100" oninput="volVal.innerText = this.value + '%'">
        
        <br><br>
        <label>Офсет: <span id="offVal" style="float:right; color:var(--accent)">-140ms</span></label>
        <input type="range" id="offRange" min="-500" max="500" value="-140" oninput="offVal.innerText = this.value + 'ms'">
        
        <br><br>
        <label>Свой ZIP-пак:</label>
        <button onclick="document.getElementById('zipInput').click()" style="width:100%; padding:12px; background:#222; border:1px solid var(--border); color:#fff; border-radius:10px; cursor:pointer;">ЗАГРУЗИТЬ ZIP</button>
        <input type="file" id="zipInput" style="display: none;" accept=".zip" onchange="loadCustomZip(this.files[0])">
    </div>
</div>

<script>
    const REPO = "Zer0one11/zcb3-web";
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let audioCache = { clicks: [], releases: [] }, macroEvents = [], currentTps = 240;

    function addLog(m) { log.innerText = "> " + m; }
    function toggleSettings(s) { settingsModal.style.display = s ? 'flex' : 'none'; }
    function toggleConverter(s) { converterModal.style.display = s ? 'flex' : 'none'; }

    // НОВАЯ ЛОГИКА ЗАГРУЗКИ: Поиск по папкам, а не по именам файлов
    async function loadCustomZip(file) {
        if(!file) return;
        addLog("Анализ папок в ZIP...");
        audioCache = { clicks: [], releases: [] };
        const zip = await JSZip.loadAsync(file);
        
        const promises = [];
        zip.forEach((path, entry) => {
            if (!entry.dir && path.toLowerCase().endsWith('.wav')) {
                const p = entry.async("arraybuffer").then(async (data) => {
                    const decoded = await ctx.decodeAudioData(data);
                    const cleanPath = path.toLowerCase();
                    // Проверяем, в какой папке лежит файл
                    if (cleanPath.includes('click')) {
                        audioCache.clicks.push(decoded.getChannelData(0));
                    } else if (cleanPath.includes('release') || cleanPath.includes('rel')) {
                        audioCache.releases.push(decoded.getChannelData(0));
                    }
                });
                promises.push(p);
            }
        });

        await Promise.all(promises);
        addLog(`Загружено из папок:\nКликов: ${audioCache.clicks.length}\nРелизов: ${audioCache.releases.length}`);
        checkReady();
    }

    async function handleMacro(file) {
        if(!file) return;
        const buf = await file.arrayBuffer();
        const v = new DataView(buf);
        macroEvents = [];

        if(file.name.endsWith('.re3')) {
            currentTps = v.getFloat32(0, true);
            const p1c = v.getUint32(4, true), p2c = v.getUint32(8, true), total = v.getUint32(12, true);
            let off = 20 + (p1c + p2c) * 32;
            for(let i=0; i<total; i++) {
                if(off+16 > buf.byteLength) break;
                macroEvents.push({ f: v.getUint32(off, true), d: v.getUint8(off+4)>0, p2: v.getUint8(off+5)!==0 });
                off += 16;
            }
            macroEvents.sort((a,b) => a.f - b.f);
        } else {
            const d = JSON.parse(new TextDecoder().decode(buf));
            currentTps = d.framerate || 240;
            const evs = d.inputs || d.events || [];
            macroEvents = evs.map(e => ({ f: e.frame ?? e.f, d: e.down ?? e.d, p2: e.p2 === true || e.player === 2 })).sort((a,b) => a.f - b.f);
        }
        addLog(`Макрос: ${file.name}\nСобытий: ${macroEvents.length}\nTPS: ${currentTps}`);
        dropZone.innerText = file.name; dropZone.classList.add('active');
        checkReady();
    }

    async function startConversion() {
        const file = convFile.files[0];
        if(!file) return;
        const mode = convMode.value;
        convStatus.innerText = "Обработка...";

        if(mode === 'j2r') {
            const d = JSON.parse(await file.text());
            const fps = d.framerate || 240;
            const evs = d.inputs || d.events || [];
            const p1 = evs.filter(e => !(e.p2 || e.player === 2));
            const p2 = evs.filter(e => (e.p2 || e.player === 2));

            const buf = new ArrayBuffer(20 + (evs.length * 32) + (evs.length * 16));
            const v = new DataView(buf);
            v.setFloat32(0, fps, true);
            v.setUint32(4, p1.length, true);
            v.setUint32(8, p2.length, true);
            v.setUint32(12, evs.length, true);

            let bodyOff = 20 + (evs.length * 32);
            [...p1, ...p2].forEach((e, i) => {
                const off = bodyOff + (i * 16);
                v.setUint32(off, e.frame || e.f || 0, true);
                v.setUint8(off + 4, (e.down || e.d) ? 1 : 0);
                v.setUint8(off + 5, (e.p2 || e.player === 2) ? 1 : 0);
            });
            downloadBlob(new Blob([buf]), file.name.replace('.json', '.re3'));
        } else {
            const buf = await file.arrayBuffer();
            const v = new DataView(buf);
            const fps = v.getFloat32(0, true);
            const total = v.getUint32(12, true);
            let off = 20 + (v.getUint32(4,true)+v.getUint32(8,true)) * 32;
            let out = { framerate: fps, events: [] };
            for(let i=0; i<total; i++) {
                if(off+16 > buf.byteLength) break;
                out.events.push({ f: v.getUint32(off,true), d: v.getUint8(off+4)>0, p2: v.getUint8(off+5)!==0 });
                off += 16;
            }
            downloadBlob(new Blob([JSON.stringify(out, null, 2)]), file.name.replace('.re3', '.json'));
        }
        convStatus.innerText = "Завершено!";
    }

    function downloadBlob(blob, name) {
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = name; a.click();
    }

    async function renderAudio() {
        const vol = volRange.value/100, off = Math.floor((offRange.value/1000)*44100);
        const lastEvent = macroEvents[macroEvents.length-1];
        const len = Math.floor((lastEvent.f / currentTps) * 44100) + 88200;
        const L = new Float32Array(len), R = new Float32Array(len);
        
        macroEvents.forEach(ev => {
            const start = Math.floor((ev.f/currentTps)*44100) + off;
            if(start < 0) return;
            const pool = ev.d ? audioCache.clicks : audioCache.releases;
            if(pool && pool.length) {
                const s = pool[Math.floor(Math.random()*pool.length)];
                const pL = ev.p2 ? 0.3 : 1.0, pR = ev.p2 ? 1.0 : 0.3;
                for(let j=0; j<s.length && (start+j)<len; j++) { L[start+j]+=s[j]*vol*pL; R[start+j]+=s[j]*vol*pR; }
            }
        });
        player.src = URL.createObjectURL(stereoWav(L,R));
        previewArea.style.display = 'block';
    }

    function stereoWav(l, r) {
        const b = new ArrayBuffer(44 + l.length * 4);
        const v = new DataView(b);
        const s = (o, t) => { for (let i = 0; i < t.length; i++) v.setUint8(o + i, t.charCodeAt(i)); };
        s(0, 'RIFF'); v.setUint32(4, 36 + l.length * 4, true);
        s(8, 'WAVE'); s(12, 'fmt '); v.setUint32(16, 16, true);
        v.setUint16(20, 1, true); v.setUint16(22, 2, true);
        v.setUint32(24, 44100, true); v.setUint32(28, 176400, true);
        v.setUint16(32, 4, true); v.setUint16(34, 16, true);
        s(36, 'data'); v.setUint32(40, l.length * 4, true);
        for (let i = 0; i < l.length; i++) {
            v.setInt16(44 + i * 4, Math.max(-1, Math.min(1, l[i])) * 32767, true);
            v.setInt16(44 + i * 4 + 2, Math.max(-1, Math.min(1, r[i])) * 32767, true);
        }
        return new Blob([b], { type: 'audio/wav' });
    }

    async function loadMainPack(f, b) {
        document.querySelectorAll('.pack-btn').forEach(x => x.classList.remove('active')); b.classList.add('active');
        addLog(`Загрузка пака ${f}...`);
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/clicks/${f}`);
        const files = await res.json();
        audioCache = { clicks: [], releases: [] };
        for (let file of files) {
            const ad = await ctx.decodeAudioData(await (await fetch(file.download_url)).arrayBuffer());
            if (file.name.toLowerCase().includes('click')) audioCache.clicks.push(ad.getChannelData(0));
            else audioCache.releases.push(ad.getChannelData(0));
        }
        addLog(`Пак ${f} загружен!`); checkReady();
    }

    async function loadZipPack(name) {
        addLog(`Скачивание ${name}.zip...`);
        const res = await fetch(`https://raw.githubusercontent.com/${REPO}/main/packs/${name}.zip`);
        loadCustomZip(await res.blob());
    }

    function checkReady() { if(audioCache.clicks.length && macroEvents.length) renderBtn.style.display = 'block'; }
    
    async function init() {
        try {
            const r = await fetch(`https://api.github.com/repos/${REPO}/contents/packs`);
            const files = await r.json();
            const sel = document.getElementById('packSelect');
            sel.innerHTML = '<option disabled selected>Или выберите ZIP из облака...</option>';
            files.filter(f => f.name.endsWith('.zip')).forEach(f => {
                const name = f.name.replace('.zip', '');
                const opt = document.createElement('option');
                opt.value = name; opt.innerText = name.toUpperCase();
                sel.appendChild(opt);
            });
        } catch(e) { addLog("Не удалось загрузить список ZIP."); }
    }
    window.onload = init;
</script>
</body>
</html>
