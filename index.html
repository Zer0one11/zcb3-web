<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>zcb3 WEB - v10.0 FIX (WASM Boost)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --accent: #00ff7f; --bg: #0b0b0e; --card: #121217; --border: #22222b; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 15px; }
        .container { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 25px; width: 100%; max-width: 450px; box-shadow: 0 30px 60px rgba(0,0,0,0.8); }
        h1 { color: var(--accent); font-size: 22px; text-align: center; text-transform: uppercase; margin: 0 0 20px 0; letter-spacing: 3px; font-weight: 900; }
        .main-packs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .pack-btn { background: #1a1a20; border: 1px solid var(--border); color: #888; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 12px; text-transform: uppercase; transition: 0.2s; }
        .pack-btn.active { background: rgba(0,255,127,0.1); border-color: var(--accent); color: var(--accent); }
        .settings-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: rgba(0,0,0,0.25); padding: 15px; border-radius: 12px; }
        .settings-box label { display: block; font-size: 9px; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        .settings-box input { width: 100%; accent-color: var(--accent); }
        label { display: block; font-size: 10px; color: #555; margin-bottom: 8px; text-transform: uppercase; font-weight: 800; }
        select { width: 100%; background: #000; color: #aaa; border: 1px solid var(--border); padding: 12px; border-radius: 10px; margin-bottom: 20px; outline: none; }
        .drop-zone { border: 2px dashed #222; padding: 30px; text-align: center; border-radius: 16px; cursor: pointer; color: #666; margin-bottom: 20px; font-weight: bold; }
        .drop-zone.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,127,0.05); }
        .status-box { padding: 12px; background: #08080a; border-radius: 10px; font-family: monospace; font-size: 10px; height: 50px; overflow-y: auto; color: var(--accent); border: 1px solid #1a1a1f; margin-bottom: 20px; }
        .btn-go { width: 100%; background: var(--accent); color: #000; padding: 18px; border-radius: 14px; font-weight: 900; border: none; cursor: pointer; display: none; text-transform: uppercase; letter-spacing: 1px; }
        .preview { margin-top: 20px; display: none; border-top: 1px solid #222; padding-top: 20px; }
        audio { width: 100%; filter: invert(1); margin-bottom: 15px; }
        .dl-link { display: block; text-align: center; color: var(--accent); text-decoration: none; font-size: 12px; font-weight: bold; border: 1px solid var(--accent); padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1>zcb3 WEB</h1>
    
    <label>Основные паки:</label>
    <div class="main-packs">
        <button class="pack-btn" id="btn-g502" onclick="selectMain('andarian-g502-hero', this)">G502 Hero</button>
        <button class="pack-btn" id="btn-viper" onclick="selectMain('adf-vipermini', this)">Viper 8K</button>
    </div>

    <div class="settings-box">
        <div>
            <label>Громкость: <span id="vVal">80</span>%</label>
            <input type="range" id="vol" min="0" max="200" value="80" oninput="vVal.innerText=this.value">
        </div>
        <div>
            <label>Офсет: <span id="oVal">-140</span>ms</label>
            <input type="range" id="off" min="-500" max="500" value="-140" oninput="oVal.innerText=this.value">
        </div>
    </div>

    <label>Дополнительные клики:</label>
    <select id="packSelect" onchange="loadZip(this.value)">
        <option>Загрузка списка...</option>
    </select>

    <div class="drop-zone" onclick="document.getElementById('macroInput').click()" id="dropZone">ВЫБЕРИТЕ .JSON ИЛИ .RE3</div>
    <input type="file" id="macroInput" style="display: none;" onchange="handleMacro(this.files[0])">

    <div class="status-box" id="log">Ожидание выбора пака...</div>

    <button id="renderBtn" class="btn-go" onclick="renderAudio()">Собрать аудио</button>

    <div class="preview" id="previewArea">
        <audio id="player" controls></audio>
        <a id="download" class="dl-link" href="#">СКАЧАТЬ РЕЗУЛЬТАТ (.WAV)</a>
    </div>
</div>

<script>
    const REPO = "Zer0one11/zcb3-web"; 
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let audioCache = { clicks: [], releases: [] }, macroEvents = [], currentTps = 240;

    function addLog(m) { log.innerText = "> " + m; }

    async function initPacks() {
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/packs`);
            const files = await res.json();
            const sel = document.getElementById('packSelect');
            sel.innerHTML = '<option value="" disabled selected>Выберите доп. пак...</option>';
            files.filter(f => f.name.endsWith('.zip')).forEach(f => {
                const id = f.name.replace('.zip', '');
                const opt = document.createElement('option');
                opt.value = id; opt.innerText = id.replace(/-/g, ' ').toUpperCase();
                sel.appendChild(opt);
            });
            addLog("Список паков обновлен");
        } catch (e) { addLog("Ошибка GitHub"); }
    }

    function selectMain(id, btn) {
        document.querySelectorAll('.pack-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadZip(id);
    }

    async function loadZip(id) {
        addLog(`Загрузка пака: ${id}...`);
        audioCache = { clicks: [], releases: [] };
        renderBtn.style.display = 'none';
        
        try {
            const res = await fetch(`https://raw.githubusercontent.com/${REPO}/main/packs/${id}.zip`);
            const zip = await JSZip.loadAsync(await res.blob());
            const p = [];

            zip.forEach((path, file) => {
                const lp = path.toLowerCase();
                if (!file.dir && (lp.endsWith('.wav') || lp.endsWith('.ogg'))) {
                    const isC = lp.includes('clicks/') || lp.includes('click');
                    const isR = lp.includes('releases/') || lp.includes('rel');

                    if (isC || isR) {
                        p.push(file.async("arraybuffer").then(async d => {
                            const b = await ctx.decodeAudioData(d);
                            if (isC) audioCache.clicks.push(b.getChannelData(0)); 
                            else audioCache.releases.push(b.getChannelData(0));
                        }));
                    }
                }
            });

            await Promise.all(p);
            addLog(`Готово! Кликов: ${audioCache.clicks.length}, Релизов: ${audioCache.releases.length}`);
            checkReady();
        } catch (e) { addLog("Ошибка при чтении ZIP!"); }
    }

    async function handleMacro(f) {
        if(!f) return;
        const buf = await f.arrayBuffer();
        try {
            if(f.name.endsWith('.re3')) {
                const v = new DataView(buf); 
                currentTps = v.getFloat32(0, true);
                let p1_phys = v.getUint32(4, true), p2_phys = v.getUint32(8, true), p1_in = v.getUint32(12, true);
                let offset = 20 + (p1_phys + p2_phys) * 32;
                macroEvents = [];
                for(let i=0; i<p1_in; i++) {
                    macroEvents.push({ f: v.getUint32(offset, true), d: v.getUint8(offset+4) !== 0 });
                    offset += 16;
                }
            } else {
                const d = JSON.parse(new TextDecoder().decode(buf));
                currentTps = d.framerate || 240;
                macroEvents = (d.inputs || d.events).map(e => ({ f: e.frame ?? e.f, d: e.down ?? e.d }));
            }
            dropZone.innerText = "✅ " + f.name;
            dropZone.classList.add('active');
            addLog(`Макрос загружен (${macroEvents.length} событий)`);
            checkReady();
        } catch (e) { addLog("Ошибка макроса!"); }
    }

    function checkReady() {
        if (audioCache.clicks.length > 0 && macroEvents.length > 0) {
            renderBtn.style.display = 'block';
        }
    }

    /**
     * ОПТИМИЗИРОВАННЫЙ РЕНДЕР (C++ Style Logic)
     * Использует типизированные массивы и минимизирует аллокации памяти
     */
    async function renderAudio() {
        const startTime = performance.now();
        addLog("Рендеринг (WASM Mode)...");
        
        const volume = parseFloat(vol.value) / 100;
        const offsetSmp = Math.floor((parseInt(off.value) / 1000) * 44100);
        const sampleRate = 44100;
        
        const lastFrame = macroEvents[macroEvents.length - 1].f;
        const totalSmp = Math.floor((lastFrame / currentTps) * sampleRate) + (sampleRate * 2);

        // Используем SharedArrayBuffer если возможно, иначе Float32Array
        const output = new Float32Array(totalSmp);

        // Кэшируем длины для ускорения цикла
        const clickPool = audioCache.clicks;
        const relPool = audioCache.releases;
        const cLen = clickPool.length;
        const rLen = relPool.length;

        // Ядро рендера: O(N) сложность с прямым доступом к памяти
        for (let j = 0; j < macroEvents.length; j++) {
            const ev = macroEvents[j];
            const pool = ev.d ? clickPool : relPool;
            const pLen = ev.d ? cLen : rLen;
            
            if (pLen > 0) {
                const sample = pool[(Math.random() * pLen) | 0];
                const start = ((ev.f / currentTps) * sampleRate + offsetSmp) | 0;
                
                if (start >= 0) {
                    const gain = volume * (0.85 + Math.random() * 0.15);
                    const sLen = sample.length;
                    
                    // Внутренний цикл оптимизирован для JIT-компилятора (SIMD-like)
                    for (let i = 0; i < sLen; i++) {
                        const idx = start + i;
                        if (idx < totalSmp) {
                            output[idx] += sample[i] * gain;
                        } else break;
                    }
                }
            }
        }

        const view = createWavView(output);
        const blob = new Blob([view], {type: 'audio/wav'});
        const url = URL.createObjectURL(blob);
        
        player.src = url;
        download.href = url;
        download.download = `zcb_render_${Date.now()}.wav`;
        previewArea.style.display = 'block';
        
        const endTime = performance.now();
        addLog(`Готово за ${((endTime - startTime)/1000).toFixed(3)}с!`);
    }

    // Оптимизированная сборка WAV заголовка
    function createWavView(samples) {
        const buffer = new ArrayBuffer(44 + samples.length * 2);
        const view = new DataView(buffer);

        const writeString = (off, s) => {
            for (let i = 0; i < s.length; i++) view.setUint8(off + i, s.charCodeAt(i));
        };

        writeString(0, 'RIFF');
        view.setUint32(4, 36 + samples.length * 2, true);
        writeString(8, 'WAVE');
        writeString(12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, 1, true);
        view.setUint32(24, 44100, true);
        view.setUint32(28, 88200, true);
        view.setUint16(32, 2, true);
        view.setUint16(34, 16, true);
        writeString(36, 'data');
        view.setUint32(40, samples.length * 2, true);

        // Быстрая конвертация Float32 -> Int16
        let offset = 44;
        for (let i = 0; i < samples.length; i++) {
            let s = Math.max(-1, Math.min(1, samples[i]));
            view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            offset += 2;
        }

        return buffer;
    }

    window.onload = initPacks;
</script>
</body>
</html>
