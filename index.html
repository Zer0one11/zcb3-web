<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>zcb3 WEB v10.0 - Clean</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --accent: #00ff7f; --bg: #0b0b0e; --card: #121217; --border: #22222b; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 25px; width: 100%; max-width: 450px; box-sizing: border-box; }
        
        h1 { color: var(--accent); text-align: center; font-size: 24px; letter-spacing: 2px; margin: 0 0 25px 0; font-weight: 900; }
        
        .pack-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .pack-btn { background: #1a1a20; border: 1px solid var(--border); color: #888; padding: 15px; border-radius: 14px; font-weight: bold; cursor: pointer; }
        .pack-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,127,0.1); }
        
        select { width: 100%; background: #1a1a20; color: #fff; border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 20px; outline: none; }
        
        .drop-zone { border: 2px dashed #333; padding: 40px 10px; text-align: center; border-radius: 20px; color: #666; font-size: 14px; margin-bottom: 20px; cursor: pointer; }
        .drop-zone.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,127,0.05); }
        
        .status-box { background: #000; padding: 15px; border-radius: 15px; font-family: monospace; font-size: 12px; color: var(--accent); min-height: 50px; border: 1px solid #1a1a1f; margin-bottom: 20px; white-space: pre-wrap; }
        
        .btn-render { width: 100%; background: var(--accent); color: #000; padding: 20px; border-radius: 18px; font-weight: 900; border: none; display: none; text-transform: uppercase; font-size: 16px; }

        .custom-link { text-align: center; color: #555; font-size: 12px; margin-top: 15px; text-decoration: underline; cursor: pointer; display: block; }
        
        .preview { margin-top: 25px; display: none; }
        audio { width: 100%; filter: invert(1); }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>zcb3 WEB</h1>

    <div class="pack-grid">
        <button class="pack-btn" onclick="loadMainPack('g502', this)">G502 Hero</button>
        <button class="pack-btn" onclick="loadMainPack('Viper-8K', this)">Razer Viper</button>
    </div>

    <select id="packSelect" onchange="loadZipPack(this.value)"><option>Выберите ZIP из облака...</option></select>

    <div class="drop-zone" onclick="document.getElementById('macroInp').click()" id="dZone">ВЫБРАТЬ МАКРОС (.RE3 / .JSON)</div>
    <input type="file" id="macroInp" onchange="handleMacro(this.files[0])">

    <div class="status-box" id="log">Ожидание...</div>
    
    <button id="rBtn" class="btn-render" onclick="render()">СГЕНЕРИРОВАТЬ WAV</button>

    <div id="pArea" class="preview">
        <audio id="aud" controls></audio>
        <a id="dl" style="display:block; text-align:center; color:var(--accent); margin-top:15px; font-weight:bold; text-decoration:none;">СКАЧАТЬ WAV</a>
    </div>

    <span class="custom-link" onclick="document.getElementById('customZip').click()">Загрузить свой ZIP с телефона</span>
    <input type="file" id="customZip" accept=".zip" onchange="loadCustomZip(this.files[0])">
</div>

<script>
    const REPO = "Zer0one11/zcb3-web";
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let audioCache = { clicks: [], releases: [] }, macro = [], fps = 240;

    const clickKeys = ['clicks', 'click'];
    const releaseKeys = ['releases', 'release'];

    function addLog(m) { log.innerText = "> " + m; }

    async function loadCustomZip(file) {
        if(!file) return;
        addLog("Распаковка ZIP...");
        audioCache = { clicks: [], releases: [] };
        try {
            const zip = await JSZip.loadAsync(file);
            const promises = [];
            
            zip.forEach((path, entry) => {
                if(!entry.dir && path.toLowerCase().endsWith('.wav')) {
                    const p = entry.async("arraybuffer").then(async (ab) => {
                        const buffer = await ctx.decodeAudioData(ab);
                        const lowPath = path.toLowerCase();
                        
                        // Проверка по списку слов
                        const isClick = clickKeys.some(key => lowPath.includes(key));
                        const isRelease = releaseKeys.some(key => lowPath.includes(key));

                        if (isClick) audioCache.clicks.push(buffer.getChannelData(0));
                        else if (isRelease) audioCache.releases.push(buffer.getChannelData(0));
                    });
                    promises.push(p);
                }
            });

            await Promise.all(promises);
            addLog(`Загружено:\nКликов: ${audioCache.clicks.length}\nРелизов: ${audioCache.releases.length}`);
            checkReady();
        } catch(e) { addLog("Ошибка ZIP: " + e.message); }
    }

    async function handleMacro(file) {
        if(!file) return;
        addLog("Чтение макроса...");
        const buf = await file.arrayBuffer();
        const v = new DataView(buf);
        macro = [];

        if(file.name.toLowerCase().endsWith('.re3')) {
            fps = v.getFloat32(0, true);
            const p1P = v.getUint32(4, true), p2P = v.getUint32(8, true), total = v.getUint32(12, true);
            let offset = 20 + (p1P + p2P) * 32;
            for(let i=0; i<total; i++) {
                if(offset + 16 > buf.byteLength) break;
                macro.push({ f: v.getUint32(offset, true), d: v.getUint8(offset + 4) > 0, p2: v.getUint8(offset + 5) !== 0 });
                offset += 16;
            }
        } else {
            const d = JSON.parse(new TextDecoder().decode(buf));
            fps = d.framerate || 240;
            const evs = d.inputs || d.events || [];
            macro = evs.map(e => ({ f: e.frame ?? e.f, d: e.down ?? e.d, p2: e.p2 || e.player === 2 }));
        }
        
        addLog(`Макрос: ${file.name}\nСобытий: ${macro.length}\nFPS: ${fps}`);
        dZone.innerText = file.name;
        dZone.classList.add('active');
        checkReady();
    }

    async function render() {
        addLog("Рендеринг...");
        const v = 1.0, o = Math.floor((-0.140)*44100);
        const last = macro[macro.length-1];
        const len = Math.floor((last.f / fps) * 44100) + 88200;
        const L = new Float32Array(len), R = new Float32Array(len);

        macro.forEach(e => {
            const s = Math.floor((e.f/fps)*44100) + o;
            if(s < 0) return;
            const pool = e.d ? audioCache.clicks : audioCache.releases;
            if(pool.length) {
                const smp = pool[Math.floor(Math.random()*pool.length)];
                const pL = e.p2 ? 0.4 : 1.0, pR = e.p2 ? 1.0 : 0.4;
                for(let j=0; j<smp.length && (s+j)<len; j++) { 
                    L[s+j]+=smp[j]*v*pL; R[s+j]+=smp[j]*v*pR; 
                }
            }
        });

        const blob = stereoWav(L, R);
        aud.src = URL.createObjectURL(blob);
        dl.href = aud.src;
        dl.download = "result.wav";
        pArea.style.display = 'block';
        addLog("Готово!");
    }

    function stereoWav(l, r) {
        const b = new ArrayBuffer(44 + l.length * 4);
        const v = new DataView(b);
        const s = (o, t) => { for (let i = 0; i < t.length; i++) v.setUint8(o + i, t.charCodeAt(i)); };
        s(0, 'RIFF'); v.setUint32(4, 36 + l.length * 4, true);
        s(8, 'WAVE'); s(12, 'fmt '); v.setUint32(16, 16, true);
        v.setUint16(20, 1, true); v.setUint16(22, 2, true);
        v.setUint32(24, 44100, true); v.setUint32(28, 176400, true);
        v.setUint16(32, 4, true); v.setUint16(34, 16, true);
        s(36, 'data'); v.setUint32(40, l.length * 4, true);
        for (let i = 0; i < l.length; i++) {
            v.setInt16(44 + i * 4, Math.max(-1, Math.min(1, l[i])) * 32767, true);
            v.setInt16(44 + i * 4 + 2, Math.max(-1, Math.min(1, r[i])) * 32767, true);
        }
        return new Blob([b], { type: 'audio/wav' });
    }

    function checkReady() { if(audioCache.clicks.length && macro.length) rBtn.style.display = 'block'; }
    
    async function loadMainPack(f, b) {
        document.querySelectorAll('.pack-btn').forEach(x => x.classList.remove('active')); b.classList.add('active');
        addLog("Загрузка...");
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/clicks/${f}`);
            const files = await res.json();
            audioCache = { clicks: [], releases: [] };
            for (let file of files) {
                const ad = await ctx.decodeAudioData(await (await fetch(file.download_url)).arrayBuffer());
                const lowName = file.name.toLowerCase();
                if (clickKeys.some(k => lowName.includes(k))) audioCache.clicks.push(ad.getChannelData(0));
                else if (releaseKeys.some(k => lowName.includes(k))) audioCache.releases.push(ad.getChannelData(0));
            }
            addLog("Пак загружен."); checkReady();
        } catch(e) { addLog("Ошибка."); }
    }

    async function loadZipPack(name) {
        addLog(`Скачивание...`);
        try {
            const res = await fetch(`https://raw.githubusercontent.com/${REPO}/main/packs/${name}.zip`);
            loadCustomZip(await res.blob());
        } catch(e) { addLog("Ошибка."); }
    }

    async function init() {
        try {
            const r = await fetch(`https://api.github.com/repos/${REPO}/contents/packs`);
            const f = await r.json();
            const s = document.getElementById('packSelect');
            f.filter(i => i.name.endsWith('.zip')).forEach(i => {
                const n = i.name.replace('.zip', '');
                const o = document.createElement('option'); o.value = n; o.innerText = n.toUpperCase();
                s.appendChild(o);
            });
        } catch(e) {}
    }
    window.onload = init;
</script>
</body>
</html>
